name: "ðŸ” Check improvements with cpp style guide"

on:
  pull_request_target:
    paths:
    - '**.cpp'
    - '**.h'
    - '.github/workflows/clangtidy-diff-analysis.yml'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze (required for clang-tidy to have files to check)'
        required: true
        type: number

jobs:
  compile-mudlet:
    name: ${{matrix.buildname}}
    runs-on: ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            buildname: 'clang-tidy'
            triplet: x64-linux
            compiler: clang_64
            qt: '6.9.0'

    env:
      BOOST_ROOT: ${{github.workspace}}/3rdparty/boost
      BOOST_URL: https://github.com/boostorg/boost/releases/download/boost-1.83.0/boost-1.83.0.7z

    steps:
    - name: Checkout Mudlet source code
      uses: actions/checkout@v6
      with:
        submodules: recursive
        fetch-depth: 0
        # https://github.com/ZedThree/clang-tidy-review/issues/10
        ref: ${{ github.event.pull_request.head.sha }}
        # https://github.community/t/github-actions-are-severely-limited-on-prs/18179/17?u=vadi2
        repository: ${{github.event.pull_request.head.repo.full_name}}

    - name: (Windows) Install Qt
      uses: jurplel/install-qt-action@v4
      if: runner.os == 'Windows'
      with:
        version: ${{matrix.qt}}
        dir: ${{github.workspace}}
        arch: win64_mingw73
        cache: true
        modules: qt5compat qtmultimedia

    - name: (Linux/macOS) Install Qt
      uses: jurplel/install-qt-action@v4
      if: runner.os == 'Linux' || runner.os == 'macOS'
      with:
        version: ${{matrix.qt}}
        dir: ${{github.workspace}}
        cache: true
        modules: qt5compat qtmultimedia

    - name: Restore Boost cache
      uses: actions/cache@v5
      id: cache-boost
      with:
        path: ${{env.BOOST_ROOT}}
        key: boost

    - name: Install Boost
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        if [ "$OS" == "Windows_NT" ]; then
          # fix up paths to be forward slashes consistently
          BOOST_ROOT=$(echo $BOOST_ROOT | sed 's/\\/\//g')
        fi
        mkdir -p $BOOST_ROOT
        curl --progress-bar --location --output $BOOST_ROOT/download.7z $BOOST_URL
        7z -o$BOOST_ROOT x $BOOST_ROOT/download.7z -y -bd
        cd $BOOST_ROOT && cp -r boost-*/* .
        rm -rf boost-*/* download.7z
      shell: bash

    - name: Use CMake 3.30.3
      uses: lukka/get-cmake@v3.30.3

    - name: (Linux) Install Lua via GitHub Actions
      uses: leafo/gh-actions-lua@v12
      if: runner.os == 'Linux'
      with:
        luaVersion: "5.1.5"
        buildCache: false

    - name: (Linux) Install Luarocks via GitHub Actions
      uses: leafo/gh-actions-luarocks@v6
      if: runner.os == 'Linux'

    - name: (Linux) Install dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update

        # Install all required dependencies
        # liblua5.1-0-dev is needed for CMake to find Lua headers/library
        sudo apt-get install libsecret-1-dev ccache pkg-config libzip-dev libglu1-mesa-dev libpulse-dev \
          libassimp-dev libpcre2-dev libpugixml-dev libsqlite3-dev libyajl-dev libhunspell-dev liblua5.1-0-dev libboost-dev -y

        # Install lua-yajl early to generate translation statistics
        luarocks install --local lua-yajl

        # Allow stats generation script to see location of lua-yajl
        eval "$(luarocks path --local --lua-version "5.1")"
        echo "LUA_PATH=$LUA_PATH" >> $GITHUB_ENV
        echo "LUA_CPATH=$LUA_CPATH" >> $GITHUB_ENV

    - name: Generate compile_commands.json
      uses: lukka/run-cmake@v3
      with:
        cmakeListsOrSettingsJson: CMakeListsTxtAdvanced
        cmakeListsTxtPath: '${{github.workspace}}/CMakeLists.txt'
        # has to be the github workspace, not the runner workspace, for the docker-based clang-tidy-review
        buildDirectory: '${{github.workspace}}/b/ninja'
        cmakeAppendedArgs: >-
          -DCMAKE_GLOBAL_AUTOGEN_TARGET=ON
          -G Ninja
          -DCMAKE_PREFIX_PATH=${{ env.QT_PREFIX != '' && env.QT_PREFIX || env.MINGW_BASE_DIR }}
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        buildWithCMakeArgs: >-
          --target autogen

    - name: Check C++ changes against style guide
      uses: ZedThree/clang-tidy-review@v0.22.2
      id: static_analysis
      with:
        pr: ${{ inputs.pr_number || github.event.pull_request.number }}
        build_dir: 'b/ninja' # path is relative to checkout directory
        exclude: '3rdparty'
        config_file: '.clang-tidy'
        # the action doesn't see system-level libraries, need to replicate them here
        apt_packages: 'gettext, pkg-config, libzip-dev, libglu1-mesa-dev, libpulse-dev, libpcre3-dev, liblua5.1-0-dev, libassimp-dev, libboost-dev, libhunspell-dev, libpugixml-dev, libsecret-1-dev, libsqlite3-dev, libyajl-dev'
        # workaround for https://github.com/ZedThree/clang-tidy-review/issues/157
        extra_arguments: '--allow-no-checks'
        split_workflow: true

    - name: Upload check results
      uses: ZedThree/clang-tidy-review/upload@v0.22.2
